# Generate an updated one-file HTML:
# - Segment labels use per-day colored backgrounds (with !important to ensure visibility)
# - Start-of-day points have a small flag marker
# - Gaode links are hidden (not shown in labels); instead:
#     * Hovering a line shows a tooltip â€œé«˜å¾·å¯¼èˆªï¼ˆç‚¹å‡»æ‰“å¼€ï¼‰â€
#     * Clicking the line opens the Gaode deep-link for that segment
# - Keep total/remaining km overlay and checkboxes on segment labels

html = r"""<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>å·ç”˜ç¯çº¿ Â· D1â€“D8 åˆ†æ®µé…è‰² Â· èµ·ç‚¹æ——å¸œ Â· çº¿æ¡æ‚¬æµ®é«˜å¾·</title>
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
  crossorigin=""
/>
<style>
  html, body, #map { height: 100%; margin: 0; }
  .tag-box, .seg-label {
    border-radius: 8px !important;
    box-shadow: 0 2px 6px rgba(0,0,0,0.18) !important;
    -webkit-backface-visibility: hidden;
    transform: translateZ(0);
  }
  .tag-box { 
    padding: 2px 8px; font-size: 11px; font-weight: 700; white-space: nowrap;
    border: 1px solid rgba(0,0,0,0.35) !important;
  }
  .seg-label {
    padding: 4px 10px; font-size: 11px; font-weight: 800; white-space: nowrap;
    display: flex; gap: 6px; align-items: center;
    border: 1px solid rgba(0,0,0,0.35) !important;
  }
  .legend {
    position: absolute; right: 10px; top: 10px; z-index: 1001;
    background: rgba(255,255,255,0.95); padding: 8px 10px; border:1px solid #999; border-radius:10px;
    font-size: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.15);
  }
  .legend .row { display:flex; align-items:center; gap:8px; margin:3px 0; }
  .legend .swatch { width:14px; height:14px; border-radius:3px; border:1px solid #666; }
  .overlay {
    position: absolute; left: 10px; top: 10px; z-index: 1001;
    background: rgba(255,255,255,0.95); padding: 10px 14px; border: 1px solid #999; border-radius: 10px;
    font-size: 13px; box-shadow: 0 2px 6px rgba(0,0,0,0.15);
  }
  .leaflet-div-icon { background: transparent !important; border: 0 !important; }
  .flag { font-size: 18px; line-height: 18px; transform: translate(0,-16px); }
</style>
</head>
<body>
<div id="map"></div>

<div class="overlay">
  <div style="font-weight:800;font-size:14px;">æ€»é‡Œç¨‹ï¼š<span id="total_km">--</span> km</div>
  <div style="margin-top:6px;font-weight:700;">å‰©ä½™é‡Œç¨‹ï¼š<span id="remain_km">--</span> km</div>
  <div style="margin-top:4px;font-size:12px;color:#666;">å‹¾é€‰å·²å®Œæˆçš„è·¯æ®µï¼Œè‡ªåŠ¨æ‰£å‡å‰©ä½™é‡Œç¨‹</div>
</div>

<div class="legend">
  <div style="font-weight:700;margin-bottom:4px;">D1â€“D8 å›¾ä¾‹</div>
  <div class="row"><span class="swatch" style="background:#d62728"></span> D1</div>
  <div class="row"><span class="swatch" style="background:#1f77b4"></span> D2</div>
  <div class="row"><span class="swatch" style="background:#2ca02c"></span> D3</div>
  <div class="row"><span class="swatch" style="background:#ff7f0e"></span> D4</div>
  <div class="row"><span class="swatch" style="background:#9467bd"></span> D5</div>
  <div class="row"><span class="swatch" style="background:#8c564b"></span> D6</div>
  <div class="row"><span class="swatch" style="background:#e377c2"></span> D7</div>
  <div class="row"><span class="swatch" style="background:#7f7f7f"></span> D8</div>
</div>

<script
  src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
  crossorigin="">
</script>
<script>
const dayColors = {
  D1:"#d62728", D2:"#1f77b4", D3:"#2ca02c", D4:"#ff7f0e",
  D5:"#9467bd", D6:"#8c564b", D7:"#e377c2", D8:"#7f7f7f"
};
function luminance(hex){
  const c = hex.replace('#',''); const r=parseInt(c.slice(0,2),16), g=parseInt(c.slice(2,4),16), b=parseInt(c.slice(4,6),16);
  return 0.299*r+0.587*g+0.114*b;
}
function textColor(hex){ return luminance(hex)>160 ? "#000" : "#fff"; }
function rgba(hex, a=0.92){
  const c = hex.replace('#',''); const r=parseInt(c.slice(0,2),16), g=parseInt(c.slice(2,4),16), b=parseInt(c.slice(4,6),16);
  return `rgba(${r},${g},${b},${a})`;
}

// Points
const points = [
  ["æˆéƒ½",30.658,104.064,"D1",500],
  ["æ¾æ½˜",32.6386,103.5975,"D1",2850],
  ["å·ä¸»å¯ºé•‡",32.77682,103.61733,"D1",3000],
  ["ä¹å¯¨æ²Ÿ",33.20000,103.90000,"D1",2000],
  ["ç¥ä»™æ± ",33.25000,103.65000,"D2",3300],
  ["è¿­éƒ¨",34.0560,103.2219,"D2",3000],
  ["æ‰å°•é‚£",34.23595,103.18631,"D3",3000],
  ["æ´›å…‹ä¹‹è·¯",34.24800,103.18000,"D3",3100],
  ["ç±³æ‹‰æ—¥å·´ä½›é˜",35.00673,102.91556,"D3",2900],
  ["åˆä½œ",34.99837,102.90999,"D3",2900],
  ["å¤æ²³",35.20256,102.52173,"D4",2900],
  ["æ‹‰åœæ¥å¯º",35.19306,102.50694,"D4",2900],
  ["æ¡‘ç§‘è‰åŸ",35.11477,102.42877,"D4",3200],
  ["ç¢Œæ›²",34.59042,102.48892,"D4",3500],
  ["éƒæœ¨å¯º",34.09139,102.63639,"D4",3300],
  ["å”å…‹",33.4106,102.46754,"D5",3400],
  ["é˜¿å",32.90502,101.70192,"D6",3300],
  ["å„è«å¯º",32.98,101.38,"D6",3400],
  ["è²å®å¶åˆ™",33.233,101.08,"D6",4000],
  ["é˜¿åï¼ˆè¿”ï¼‰",32.90502,101.70192,"D6",3300],
  ["è§‚éŸ³æ¡¥",31.79968,101.65295,"D7",2500],
  ["ç‰ç§‘è‰åŸ",31.28858,101.17983,"D7",3800],
  ["å…šå²­",30.8521,101.9338,"D7",3200],
  ["ä¸¹å·´",30.877,101.886,"D7",1900],
  ["å·´éƒå±±",30.889,102.869,"D8",4460],
  ["æˆéƒ½ï¼ˆç»ˆï¼‰",30.658,104.064,"D8",500]
];
const order = [
  "æˆéƒ½","æ¾æ½˜","å·ä¸»å¯ºé•‡","ä¹å¯¨æ²Ÿ",
  "ç¥ä»™æ± ","è¿­éƒ¨",
  "æ‰å°•é‚£","æ´›å…‹ä¹‹è·¯","ç±³æ‹‰æ—¥å·´ä½›é˜","åˆä½œ",
  "å¤æ²³","æ‹‰åœæ¥å¯º","æ¡‘ç§‘è‰åŸ","ç¢Œæ›²","éƒæœ¨å¯º",
  "å”å…‹",
  "é˜¿å","å„è«å¯º","è²å®å¶åˆ™","é˜¿åï¼ˆè¿”ï¼‰",
  "è§‚éŸ³æ¡¥","ç‰ç§‘è‰åŸ","å…šå²­","ä¸¹å·´",
  "å·´éƒå±±","æˆéƒ½ï¼ˆç»ˆï¼‰"
];

// Day start flags (based on your original D1â€“D8 narrative)
const dayStarts = {
  "D1":"æˆéƒ½",
  "D2":"ä¹å¯¨æ²Ÿ",
  "D3":"è¿­éƒ¨",
  "D4":"åˆä½œ",
  "D5":"éƒæœ¨å¯º",
  "D6":"å”å…‹",
  "D7":"é˜¿å",
  "D8":"ä¸¹å·´"
};

const pt = {}; points.forEach(([n,lat,lon,day,elev])=>pt[n]={lat,lon,day,elev});

function haversineKm(lat1,lon1,lat2,lon2){
  const R=6371; const dLat=(lat2-lat1)*Math.PI/180, dLon=(lon2-lon1)*Math.PI/180;
  const a=Math.sin(dLat/2)**2+Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
  return 2*R*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
}
function roadKm(lat1,lon1,lat2,lon2){ return haversineKm(lat1,lon1,lat2,lon2)*1.35; }
function baselineTimeStr(km, elev1, elev2){
  const speed = Math.max(elev1,elev2)>=2500 ? 45 : 60;
  const m = Math.round((km/speed)*60); return `${Math.floor(m/60)}h${(m%60).toString().padStart(2,'0')}m`;
}

const segments=[];
let totalKm=0;
for(let i=0;i<order.length-1;i++){
  const a=order[i], b=order[i+1];
  const A=pt[a], B=pt[b];
  const dist = Math.round(roadKm(A.lat,A.lon,B.lat,B.lon));
  totalKm+=dist;
  const day = A.day;
  const timeStr = baselineTimeStr(dist, A.elev, B.elev);
  const amap = `https://uri.amap.com/navigation?from=${A.lon},${A.lat},${encodeURIComponent(a)}&to=${B.lon},${B.lat},${encodeURIComponent(b)}&mode=car&src=chatgpt`;
  segments.push({from:a,to:b,day,dist,timeStr,amap,A,B});
}

const map = L.map('map').setView([33.0,102.6], 6);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 18, attribution: '&copy; OpenStreetMap'
}).addTo(map);

// total/remaining
document.getElementById('total_km').textContent = totalKm;
document.getElementById('remain_km').textContent = totalKm;

function recalcRemaining(){
  let checked=0;
  document.querySelectorAll('.segchk').forEach(chk=>{
    if(chk.checked){ checked += parseInt(chk.dataset.dist||'0',10); }
  });
  document.getElementById('remain_km').textContent = Math.max(0, totalKm-checked);
}

// draw segments
segments.forEach((seg, idx)=>{
  const color = dayColors[seg.day] || '#333';
  const fg = (luminance(color)>160 ? "#000" : "#fff");
  const bg = rgba(color, 0.92);

  // polyline with hover tooltip and click to open Amap
  const line = L.polyline([[seg.A.lat,seg.A.lon],[seg.B.lat,seg.B.lon]], {color, weight:5, opacity:0.95})
    .addTo(map)
    .bindTooltip("é«˜å¾·å¯¼èˆªï¼ˆç‚¹å‡»æ‰“å¼€ï¼‰", {sticky:true});

  line.on('click', ()=>{ window.open(seg.amap, '_blank'); });

  // midpoint colored label with checkbox (no visible Gaode link)
  const mid = [(seg.A.lat+seg.B.lat)/2,(seg.A.lon+seg.B.lon)/2];
  const html = `
    <div class="seg-label" style="background:${bg} !important;color:${fg} !important;border-color:${color} !important;">
      <input type="checkbox" class="segchk" id="segcb_${idx}" data-dist="${seg.dist}" />
      <label for="segcb_${idx}" style="margin:0;cursor:pointer;">
        ${seg.day} Â· ${seg.from} â†’ ${seg.to} Â· ${seg.dist} km Â· ${seg.timeStr}
      </label>
    </div>`;
  L.marker(mid, {icon: L.divIcon({className:'', html})}).addTo(map);
});

// point labels and day-start flags
points.forEach(([name,lat,lon,day,elev])=>{
  const color = dayColors[day] || '#333';
  const fg = (luminance(color)>160 ? "#000" : "#fff");
  const bg = rgba(color, 0.90);

  // small colored dot
  L.circleMarker([lat,lon], {radius:4, weight:2, color, fillColor: color, fillOpacity:1}).addTo(map);
  // always-visible label
  const tagHtml = `<div class="tag-box" style="background:${bg} !important;color:${fg} !important;border-color:${color} !important;">
    ${day} ${name}ï½œ${elev} m
  </div>`;
  L.marker([lat,lon], {icon: L.divIcon({className:'', html:tagHtml})}).addTo(map);
});

// add flags to day starts
Object.entries(dayStarts).forEach(([d, startName])=>{
  const p = pt[startName];
  if(!p) return;
  const color = dayColors[d] || '#333';
  const flagHtml = `<div class="flag" title="${d} èµ·ç‚¹">ğŸš©</div>`;
  L.marker([p.lat, p.lon], {icon: L.divIcon({className:'', html:flagHtml})}).addTo(map);
});

// checkbox logic
document.addEventListener('change', e=>{
  if(e.target && e.target.classList.contains('segchk')) recalcRemaining();
});
</script>
</body>
</html>
"""
path = "/mnt/data/å·ç”˜ç¯çº¿-ç½‘é¡µç‰ˆ-åˆ†å¤©é…è‰²-èµ·ç‚¹æ——å¸œ-çº¿æ‚¬æµ®é«˜å¾·.html"
with open(path, "w", encoding="utf-8") as f:
    f.write(html)
path
