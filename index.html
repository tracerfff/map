# Build a color-coded interactive map by day (D1–D8):
# - Polylines colored per day
# - Midpoint label boxes colored per day (distance + baseline time)
# - Always-visible point labels prefixed with day and suffixed with elevation
# - Keep Gaode (AMap) deep-links for each segment for real-time ETA

import math
import folium
from folium.features import DivIcon

# --------------------------
# Data
# --------------------------
points = [
    ("成都", 30.658, 104.064, "D1", 500),
    ("松潘", 32.6386, 103.5975, "D1", 2850),
    ("川主寺镇", 32.77682, 103.61733, "D1", 3000),
    ("九寨沟", 33.20000, 103.90000, "D1", 2000),
    ("神仙池", 33.25000, 103.65000, "D2", 3300),   # 近似
    ("迭部", 34.0560, 103.2219, "D2", 3000),
    ("扎尕那", 34.23595, 103.18631, "D3", 3000),
    ("洛克之路", 34.24800, 103.18000, "D3", 3100), # 近似
    ("米拉日巴佛阁", 35.00673, 102.91556, "D3", 2900),
    ("合作", 34.99837, 102.90999, "D3", 2900),
    ("夏河", 35.20256, 102.52173, "D4", 2900),
    ("拉卜楞寺", 35.19306, 102.50694, "D4", 2900),
    ("桑科草原", 35.11477, 102.42877, "D4", 3200),
    ("碌曲", 34.59042, 102.48892, "D4", 3500),
    ("郎木寺", 34.09139, 102.63639, "D4", 3300),
    ("唐克", 33.4106, 102.46754, "D5", 3400),
    ("阿坝", 32.90502, 101.70192, "D6", 3300),
    ("各莫寺", 32.98000, 101.38000, "D6", 3400),   # 近似
    ("莲宝叶则", 33.23300, 101.08000, "D6", 4000), # 入口近似
    ("阿坝（返）", 32.90502, 101.70192, "D6", 3300),
    ("观音桥", 31.79968, 101.65295, "D7", 2500),
    ("玉科草原", 31.28858, 101.17983, "D7", 3800),
    ("党岭", 30.8521, 101.9338, "D7", 3200),
    ("丹巴", 30.877, 101.886, "D7", 1900),
    ("巴郎山", 30.889, 102.869, "D8", 4460),
    ("成都（终）", 30.658, 104.064, "D8", 500),
]

route_order = [
    "成都","松潘","川主寺镇","九寨沟",
    "神仙池","迭部",
    "扎尕那","洛克之路","米拉日巴佛阁","合作",
    "夏河","拉卜楞寺","桑科草原","碌曲","郎木寺",
    "唐克",
    "阿坝","各莫寺","莲宝叶则","阿坝（返）",
    "观音桥","玉科草原","党岭","丹巴",
    "巴郎山","成都（终）"
]

pt = {name: (lat, lon, day, elev) for (name, lat, lon, day, elev) in points}

# --------------------------
# Helpers
# --------------------------
def haversine_km(lat1, lon1, lat2, lon2):
    R = 6371.0
    dlat = math.radians(lat2 - lat1)
    dlon = math.radians(lon2 - lon1)
    a = math.sin(dlat/2)**2 + math.cos(math.radians(lat1))*math.cos(math.radians(lat2))*math.sin(dlon/2)**2
    c = 2 * math.atan2(math.sqrt(a), math.sqrt(1-a))
    return R * c

def road_distance_km_gc(lat1, lon1, lat2, lon2):
    return haversine_km(lat1, lon1, lat2, lon2) * 1.35

def baseline_time_hours(dist_km, elev1, elev2):
    speed = 45 if max(elev1, elev2) >= 2500 else 60
    return dist_km / speed

def hhmm(hours):
    m = int(round(hours*60))
    return f"{m//60}h{m%60:02d}m"

def hex_to_rgb(hex_color):
    hex_color = hex_color.lstrip('#')
    return tuple(int(hex_color[i:i+2], 16) for i in (0,2,4))

def rgb_to_css(r,g,b,a=0.9):
    return f"rgba({r},{g},{b},{a})"

def text_color_for_bg(hex_color):
    r,g,b = hex_to_rgb(hex_color)
    # perceived luminance
    lum = 0.299*r + 0.587*g + 0.114*b
    return "#000000" if lum > 160 else "#ffffff"

# Day color palette
day_colors = {
    "D1": "#d62728",
    "D2": "#1f77b4",
    "D3": "#2ca02c",
    "D4": "#ff7f0e",
    "D5": "#9467bd",
    "D6": "#8c564b",
    "D7": "#e377c2",
    "D8": "#7f7f7f",
}

# --------------------------
# Build segments
# --------------------------
segments = []
for i in range(len(route_order)-1):
    a, b = route_order[i], route_order[i+1]
    lat1, lon1, dayA, elev1 = pt[a]
    lat2, lon2, dayB, elev2 = pt[b]
    dist = road_distance_km_gc(lat1, lon1, lat2, lon2)
    t = baseline_time_hours(dist, elev1, elev2)
    day = dayA  # color by starting day's segment
    segments.append({
        "from": a, "to": b,
        "lat1": lat1, "lon1": lon1, "lat2": lat2, "lon2": lon2,
        "elev1": elev1, "elev2": elev2,
        "dist_km": int(round(dist)),
        "time_str": hhmm(t),
        "day": day,
        "amap": f"https://uri.amap.com/navigation?from={lon1},{lat1},{a}&to={lon2},{lat2},{b}&mode=car&src=chatgpt"
    })

# --------------------------
# Make the map
# --------------------------
m = folium.Map(location=[33.0, 102.6], zoom_start=6, control_scale=True)

# Draw segments (colored per day) + colored label boxes + amap link pins
for seg in segments:
    color = day_colors.get(seg["day"], "#333333")
    txt_color = text_color_for_bg(color)
    bg_rgba = rgb_to_css(*hex_to_rgb(color), a=0.92)
    # line
    folium.PolyLine([(seg["lat1"], seg["lon1"]), (seg["lat2"], seg["lon2"])],
                    weight=5, opacity=0.95, color=color,
                    tooltip=f"{seg['from']} → {seg['to']} · {seg['dist_km']} km · {seg['time_str']} ({seg['day']})"
                    ).add_to(m)
    # midpoint colored box
    mid_lat = (seg["lat1"] + seg["lat2"]) / 2
    mid_lon = (seg["lon1"] + seg["lon2"]) / 2
    label_html = f"""
    <div style="background:{bg_rgba};color:{txt_color};
                padding:3px 8px;border-radius:8px;border:1px solid {color};
                font-size:11px;font-weight:700;white-space:nowrap;">
        {seg['day']} · {seg['from']} → {seg['to']} · {seg['dist_km']} km · {seg['time_str']}
    </div>"""
    folium.Marker([mid_lat, mid_lon],
                  icon=DivIcon(icon_size=(280,32), icon_anchor=(0,0), html=label_html)).add_to(m)
    # amap deep-link pin (small)
    folium.Marker([mid_lat+0.03, mid_lon],
                  icon=folium.Icon(color="green", icon="cloud"),
                  tooltip="高德导航（实时）",
                  popup=folium.Popup(f"<a href='{seg['amap']}' target='_blank'>在高德打开此段</a>", max_width=260)
                 ).add_to(m)

# Points with always-visible labels: prefix day + name + elevation
for name, (lat, lon, day, elev) in pt.items():
    color = day_colors.get(day, "#333333")
    txt_color = text_color_for_bg(color)
    bg_rgba = rgb_to_css(*hex_to_rgb(color), a=0.90)
    # small dot
    folium.CircleMarker([lat, lon], radius=4, weight=2, fill=True, fill_opacity=1, color=color).add_to(m)
    # label
    tag = f"{day} {name}｜{elev} m"
    folium.Marker([lat, lon],
                  icon=DivIcon(icon_size=(160,24), icon_anchor=(0, -10),
                               html=f"<div style='background:{bg_rgba};color:{txt_color};padding:2px 6px;border-radius:6px;border:1px solid {color};font-size:11px;white-space:nowrap'>{tag}</div>")
                 ).add_to(m)

out_path = "/mnt/data/川甘环线-交互地图-分天配色-常显标签-高德深链.html"
m.save(out_path)

out_path
