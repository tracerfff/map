
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>川甘环线 </title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
  :root { --chip-radius: 10px; --chip-shadow: 0 2px 6px rgba(0,0,0,0.18); --chip-font: 12px; --chip-weight: 800;
          --sysfont: system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif; }
  html, body, #map { height: 100%; margin: 0; font-family: var(--sysfont); }
  .legend { position: absolute; right: 10px; top: 10px; z-index: 1001; background: rgba(255,255,255,0.95);
            padding: 8px 10px; border:1px solid #999; border-radius:10px; font-size: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.15); min-width: 260px; }
  .legend .row { display:flex; align-items:center; gap:8px; margin:6px 0; }
  .legend .btn-day { border:1px solid #666; border-radius:8px; font-weight:800; padding:2px 8px; cursor:pointer; user-select:none; }
  .legend .route-text { flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; color:#333; }
  .legend .btn-day.active { box-shadow: 0 0 0 2px rgba(0,0,0,0.1) inset; }
  .legend .edit { border:1px solid #999; border-radius:6px; padding:2px 6px; cursor:pointer; font-weight:700; }
  .legend .helper { font-size:11px; color:#666; margin-top:6px; line-height:1.4; }
  .overlay { position: absolute; left: 10px; top: 10px; z-index: 1001; background: rgba(255,255,255,0.95);
             padding: 10px 14px; border: 1px solid #999; border-radius: 10px; font-size: 13px; box-shadow: 0 2px 6px rgba(0,0,0,0.15); }
  .overlay .row { display:flex; align-items:center; gap:10px; }
  .chip { border-radius: var(--chip-radius) !important; box-shadow: var(--chip-shadow) !important; border: 1px solid rgba(0,0,0,0.35) !important;
          -webkit-backface-visibility: hidden; transform: translateZ(0); display: inline-flex; align-items: center; gap: 8px;
          padding: 6px 10px; font-size: var(--chip-font); font-weight: var(--chip-weight); line-height: 1; white-space: nowrap; font-family: var(--sysfont);
          backdrop-filter: blur(1px); }
  .chip--point { padding: 4px 8px; }
  .leaflet-div-icon { background: transparent !important; border: 0 !important; }
  .flag-svg { width: 22px; height: 22px; transform: translate(0,-18px); }
  .segchk { appearance: none; -webkit-appearance: none; width: 16px; height: 16px; border-radius: 4px; border: 2px solid rgba(255,255,255,0.9);
            outline: none; display: inline-block; position: relative; cursor: pointer; background: rgba(255,255,255,0.25); }
  .segchk::after { content: "✓"; position: absolute; top: -2px; left: 2px; font-size: 14px; color: #fff; opacity: 0; transform: scale(0.5); transition: all .15s ease; }
  .segchk:checked { background: rgba(0,0,0,0.3); } .segchk:checked::after { opacity: 1; transform: scale(1); }
  .dimmed { filter: saturate(35%) brightness(0.95); opacity: 0.5; }
  .muted { filter: saturate(20%) brightness(0.9); opacity: 0.35; }
  .right-controls { position:absolute; right:10px; bottom:10px; z-index:1002; display:flex; gap:10px; flex-direction:column; align-items:flex-end; }
  .btn { background:#111; color:#fff; padding:10px 12px; border-radius:12px; border:1px solid #333; cursor:pointer; font-weight:800; font-size:12px; box-shadow:0 2px 6px rgba(0,0,0,.2); }
  .navbtn { display:inline-flex; align-items:center; gap:4px; padding:4px 8px; border-radius:8px; text-decoration:none; font-weight:800; font-size:11px; }
</style>
</head>
<body>
<div id="map"></div>
<div class="overlay">
  <div class="row">
    <div style="font-weight:800;font-size:14px;">总里程：<span id="total_km">--</span> km</div>
    <div style="font-weight:700;">剩余：<span id="remain_km">--</span> km</div>
    <button id="resetBtn" class="btn" title="重置所有勾选">重置</button>
  </div>
</div>
<div class="legend" id="legend">
  <div style="font-weight:700;margin-bottom:6px;">按日聚焦（点击按钮高亮当日）</div>
  <!-- rows injected by JS -->
  <div class="helper">
    可编辑路线：点右侧<strong>编辑</strong>，输入如“成都→九寨沟”或“九寨沟→神仙池→迭部”。<br/>
    可用地名：<span id="namesList"></span>
  </div>
</div>

<div class="right-controls">
  <button id="locBtn" class="btn">定位到我</button>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const dayColors = { D1:"#d62728", D2:"#1f77b4", D3:"#2ca02c", D4:"#ff7f0e", D5:"#9467bd", D6:"#8c564b", D7:"#e377c2", D8:"#7f7f7f" };
function rgba(hex,a=0.55){ const c=hex.replace('#',''); const r=parseInt(c.slice(0,2),16), g=parseInt(c.slice(2,4),16), b=parseInt(c.slice(4,6),16); return `rgba(${r},${g},${b},${a})`; }
function haversineKm(lat1,lon1,lat2,lon2){ const R=6371, dLat=(lat2-lat1)*Math.PI/180, dLon=(lat2-lon1)*Math.PI/180;
  const a=Math.sin(dLat/2)**2+Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2; return 2*R*Math.atan2(Math.sqrt(a),Math.sqrt(1-a)); }
function roadKmGuess(A,B){ return Math.round(haversineKm(A.lat,A.lon,B.lat,B.lon)*1.55); }

// —— 地点清单 ——
const pointsRaw = [
  ["成都",30.658,104.064,"D1",500],
  ["九寨沟",33.20000,103.90000,"D1",2000],
  ["神仙池",33.25000,103.65000,"D2",3300],
  ["迭部",34.0560,103.2219,"D2",3000],
  ["扎尕那",34.23595,103.18631,"D3",3000],
  ["洛克之路",34.24800,103.18000,"D3",3100],
  ["米拉日巴佛阁",35.00673,102.91556,"D3",2900],
  ["合作",34.99837,102.90999,"D3",2900],
  ["夏河",35.20256,102.52173,"D4",2900],
  ["拉卜楞寺",35.19306,102.50694,"D4",2900],
  ["桑科草原",35.11477,102.42877,"D4",3200],
  ["碌曲",34.59042,102.48892,"D4",3500],
  ["郎木寺",34.09139,102.63639,"D4",3300],
  ["唐克",33.4106,102.46754,"D5",3400],
  ["阿坝",32.90502,101.70192,"D6",3300],
  ["各莫寺",32.98,101.38,"D6",3400],
  ["莲宝叶则",33.233,101.08,"D6",4000],
  ["观音桥",31.79968,101.65295,"D7",2500],
  ["玉科草原",31.28858,101.17983,"D7",3800],
  ["党岭",30.8521,101.9338,"D7",3200],
  ["丹巴",30.877,101.886,"D7",1900],
  ["巴郎山",30.889,102.869,"D8",4460],
  ["成都（终）",30.658,104.064,"D8",500]
];

// —— 默认按日序列（可编辑） ——
let daySeqs = {
  D1: ["成都","九寨沟"],
  D2: ["九寨沟","神仙池","迭部"],
  D3: ["迭部","扎尕那","洛克之路","米拉日巴佛阁","合作"],
  D4: ["合作","夏河","拉卜楞寺","桑科草原","碌曲","郎木寺"],
  D5: ["郎木寺","唐克"],
  D6: ["唐克","阿坝","各莫寺","莲宝叶则","阿坝"],
  D7: ["阿坝","观音桥","玉科草原","党岭","丹巴"],
  D8: ["丹巴","巴郎山","成都（终）"]
};

// —— 图注覆盖公里数（默认用），若某日被编辑，则该日的段改用 roadKmGuess ——
const overrideKmDefault = {
  "成都→九寨沟": 412,
  "九寨沟→神仙池": 70, "神仙池→迭部":200,
  "迭部→扎尕那":35, "扎尕那→洛克之路":8, "洛克之路→米拉日巴佛阁":120, "米拉日巴佛阁→合作":2,
  "合作→夏河":63, "夏河→拉卜楞寺":2, "拉卜楞寺→桑科草原":12, "桑科草原→碌曲":65, "碌曲→郎木寺":85,
  "郎木寺→唐克":120,
  "唐克→阿坝":120, "阿坝→各莫寺":35, "各莫寺→莲宝叶则":90, "莲宝叶则→阿坝":95,
  "阿坝→观音桥":200, "观音桥→玉科草原":60, "玉科草原→党岭":110, "党岭→丹巴":50,
  "丹巴→巴郎山":95, "巴郎山→成都（终）":175
};

// —— 状态容器 ——
let map, segments=[], amapLinks=[], polyRefs=[], labelRefs=[], checkRefs=[], pointMarkers=[], pointMarkersByDay={}, pointLookup={};
let STORAGE_KEY="chuan_gan_editable_v1";

function initMap(){
  map=L.map('map',{ zoomControl:true }).setView([30.658,104.064],7);
  L.tileLayer('https://webrd0{s}.is.autonavi.com/appmaptile?lang=zh_cn&size=1&scale=1&style=7&x={x}&y={y}&z={z}', {
    subdomains: "1234", attribution: "高德地图"
  }).addTo(map);
}

function buildLookup(){
  pointLookup={};
  pointsRaw.forEach(([n,lat,lon,day,elev])=> pointLookup[n]={name:n,lat,lon,day,elev});
  document.getElementById('namesList').textContent = Object.keys(pointLookup).join('、');
}

function concatOrderFromDaySeqs(){
  const days=["D1","D2","D3","D4","D5","D6","D7","D8"];
  let ord=[];
  days.forEach(d=>{
    const seq=daySeqs[d]||[];
    if(seq.length>0){
      if(ord.length>0 && ord[ord.length-1]===seq[0]){
        ord = ord.concat(seq.slice(1));
      }else{
        ord = ord.concat(seq);
      }
    }
  });
  return ord;
}

function computeOverrideKm(a,b,dayEditedSet){
  const key=`${a}→${b}`;
  if(dayEditedSet && dayEditedSet.has(pointLookup[b]?.day)) return null; // edited day's segments use guess
  if(overrideKmDefault[key]!=null) return overrideKmDefault[key];
  return null;
}

function clearLayers(){
  segments=[]; amapLinks=[]; polyRefs.forEach(p=> map.removeLayer(p)); polyRefs=[];
  labelRefs.forEach(m=> map.removeLayer(m)); labelRefs=[];
  pointMarkers.forEach(m=> map.removeLayer(m)); pointMarkers=[]; pointMarkersByDay={};
  checkRefs=[];
}

function addPointMarker(name){
  const p=pointLookup[name]; if(!p) return;
  const color=dayColors[p.day]||'#333', bg=rgba(color,0.55);
  const html=`<div class="chip chip--point dynfs" data-day="${p.day}" style="background:${bg} !important;color:#fff !important;border-color:${color} !important;">${p.day} ${name}｜${p.elev} m</div>`;
  const m=L.marker([p.lat,p.lon],{icon:L.divIcon({className:'',html})}).addTo(map);
  pointMarkers.push(m); (pointMarkersByDay[p.day]||(pointMarkersByDay[p.day]=[])).push(m);
}

function buildAll(){
  clearLayers();
  const order = concatOrderFromDaySeqs();

  // 仅绘制在 order 中出现的点（满足 #2）
  const uniq = Array.from(new Set(order));
  uniq.forEach(addPointMarker);

  // 段与文本框
  const dayEditedSet = restoredEdits();
  for(let i=0;i<order.length-1;i++){
    const a=order[i], b=order[i+1]; const A=pointLookup[a], B=pointLookup[b];
    if(!A||!B) continue;
    const day=B.day;
    const distOverride = computeOverrideKm(a,b, new Set(dayEditedSet));
    const distKm = distOverride!=null ? distOverride : roadKmGuess(A,B);
    const amap=`https://uri.amap.com/navigation?from=${A.lon},${A.lat},${encodeURIComponent(a)}&to=${B.lon},${B.lat},${encodeURIComponent(b)}&mode=car&src=chatgpt`;
    amapLinks.push(amap);
    const seg={from:a,to:b,day,distKm,A,B}; segments.push(seg);

    const color=dayColors[day]; const bg=rgba(color,0.55);
    const line=L.polyline([[A.lat,A.lon],[B.lat,B.lon]],{color,weight:5,opacity:0.95}).addTo(map);
    polyRefs.push(line);
    const mid=[(A.lat+B.lat)/2,(A.lon+B.lon)/2];
    const navStyle=`color:#fff; background:${rgba(color,0.18)}; border:1px solid ${color};`;
    const html=`<div class="chip dynfs" style="background:${bg} !important;color:#fff !important;border-color:${color} !important;">
        <input type="checkbox" class="segchk" data-idx="${i}" data-dist="${distKm}" />
        <span>${day} · ${a} → ${b} · <span class="kmv" data-idx="${i}">${distKm}</span> km</span>
        <a class="navbtn" style="${navStyle}" href="${amapLinks[i]}" target="_blank">导航</a>
      </div>`;
    const marker=L.marker(mid,{icon:L.divIcon({className:'',html})}).addTo(map);
    labelRefs.push(marker);
  }

  // 勾选恢复（顺序约束）
  setTimeout(()=>{
    document.querySelectorAll('.segchk').forEach((el,idx)=>{ checkRefs[idx]=el; });
    restoreChecks(); refreshVisuals(); buildLegend(); updateTotals();
  },0);
}

function updateTotals(){
  const total = segments.reduce((s,seg)=> s+(parseInt(seg.distKm)||0), 0);
  const checked = checkRefs.reduce((s,el)=> s+(el && el.checked ? (parseInt(el.getAttribute('data-dist'))||0):0), 0);
  document.getElementById('total_km').textContent = total;
  document.getElementById('remain_km').textContent = Math.max(0,total-checked);
}

function restoreChecks(){
  const save = JSON.parse(localStorage.getItem(STORAGE_KEY)||'{"checks":[]}');
  const arr = Array.isArray(save.checks)?save.checks:[];
  // 只能恢复到连续的最大前缀
  let last=-1;
  for(let i=0;i<Math.min(arr.length, checkRefs.length); i++){
    if(arr[i]===1){
      if(i===last+1){ checkRefs[i].checked=true; last=i; } else { break; }
    } else { break; }
  }
  applySeqRules();
}

function saveChecks(){
  const checks = checkRefs.map(el=> el && el.checked ? 1 : 0);
  const edits = JSON.parse(localStorage.getItem(STORAGE_KEY)||'{}').edits || {};
  localStorage.setItem(STORAGE_KEY, JSON.stringify({checks, edits}));
}

function applySeqRules(){
  checkRefs.forEach(el=>{ if(el) el.disabled=true; });
  let firstUnchecked = checkRefs.findIndex(el=> el && !el.checked);
  if(firstUnchecked===-1) firstUnchecked=checkRefs.length-1;
  if(checkRefs[firstUnchecked]) checkRefs[firstUnchecked].disabled=false;
}

function refreshVisuals(){
  // 已勾选降饱和
  checkRefs.forEach((el,i)=>{
    const poly=polyRefs[i], lab=labelRefs[i];
    if(el && el.checked){
      if(poly&&poly._path){ poly._path.style.filter="saturate(35%) brightness(0.95)"; poly._path.style.opacity="0.45"; }
      if(lab){ const nd=lab.getElement(); if(nd) nd.classList.add('dimmed'); }
    }else{
      if(poly&&poly._path){ poly._path.style.filter=""; poly._path.style.opacity="0.95"; }
      if(lab){ const nd=lab.getElement(); if(nd) nd.classList.remove('dimmed'); }
    }
  });
  updateTotals();
}

document.addEventListener('change', e=>{
  const t=e.target;
  if(t && t.classList.contains('segchk')){
    const idx=Number(t.getAttribute('data-idx'));
    const prev=idx-1;
    if(prev>=0 && (!checkRefs[prev] || !checkRefs[prev].checked)){
      t.checked=false; return;
    }
    if(!t.checked){
      for(let j=idx+1;j<checkRefs.length;j++){ if(checkRefs[j]) checkRefs[j].checked=false; }
    }
    applySeqRules(); refreshVisuals(); saveChecks();
  }
});
document.getElementById('resetBtn').addEventListener('click',()=>{
  checkRefs.forEach(el=>{ if(el) el.checked=false; });
  const obj=JSON.parse(localStorage.getItem(STORAGE_KEY)||'{}'); localStorage.setItem(STORAGE_KEY, JSON.stringify({checks:[], edits:obj.edits||{}}));
  applySeqRules(); refreshVisuals();
});

// —— 缩放联动：小比例隐藏 ——
function zoomFonts(){
  const z=map.getZoom(); const scale=Math.max(0.6, Math.min(1.6, 0.2*(z-8)+1)); const hide=5;
  document.querySelectorAll('.dynfs').forEach(el=>{
    if(z<=hide){ el.style.display='none'; } else { el.style.display='inline-flex'; el.style.transform=`scale(${scale})`; el.style.transformOrigin='left center'; }
  });
}
function centerAtStart(){ map.setView([30.658,104.064],7); }
document.addEventListener('DOMContentLoaded', ()=>{ zoomFonts(); centerAtStart(); });
window.addEventListener('load', zoomFonts);
window.addEventListener('resize', zoomFonts);
if(window.map) map.on && map.on('zoomend', zoomFonts);

// —— 定位到我（仅平移） ——
let meMarker=null, meCircle=null;
document.getElementById('locBtn').addEventListener('click', ()=>{
  if(!navigator.geolocation){ alert('当前浏览器不支持定位'); return; }
  navigator.geolocation.getCurrentPosition(pos=>{
    const {latitude, longitude, accuracy} = pos.coords;
    if(!meMarker){
      const html=`<div style="width:14px;height:14px;border-radius:50%;background:#2563eb;border:2px solid #fff;box-shadow:0 0 0 6px rgba(37,99,235,0.15)"></div>`;
      meMarker=L.marker([latitude,longitude],{icon:L.divIcon({className:'', html, iconSize:[14,14], iconAnchor:[7,7]})}).addTo(map);
      meCircle=L.circle([latitude,longitude],{radius:accuracy||30,color:'#2563eb',weight:1,fillColor:'#2563eb',fillOpacity:0.12}).addTo(map);
    }else{
      meMarker.setLatLng([latitude,longitude]);
      meCircle.setLatLng([latitude,longitude]); meCircle.setRadius(accuracy||30);
    }
    map.panTo([latitude, longitude]);
  }, err=>{ alert('定位失败：'+err.message); }, {enableHighAccuracy:true, timeout:12000, maximumAge:60000});
});

// —— 交互图例：聚焦 + 编辑 ——
const daysOrder = ["D1","D2","D3","D4","D5","D6","D7","D8"];
const dayFocus = { current: null };

function buildLegend(){
  const legendEl=document.getElementById('legend');
  // 清旧 rows
  legendEl.querySelectorAll('.row').forEach(n=> n.remove());
  // 生成 rows
  daysOrder.forEach(d=>{
    const row=document.createElement('div'); row.className='row';
    const btn=document.createElement('div'); btn.className='btn-day'; btn.textContent=d;
    btn.style.background = rgba(dayColors[d],0.15);
    btn.style.color = '#000'; btn.style.borderColor = dayColors[d]; btn.dataset.day = d;
    const text=document.createElement('div'); text.className='route-text'; text.textContent = (daySeqs[d]||[]).join("→");
    const edit=document.createElement('div'); edit.className='edit'; edit.textContent='编辑'; edit.dataset.day=d;
    row.appendChild(btn); row.appendChild(text); row.appendChild(edit);
    legendEl.insertBefore(row, legendEl.querySelector('.helper'));

    btn.addEventListener('click', ()=> toggleFocus(d, btn));
    edit.addEventListener('click', ()=> editDay(d));
  });
}

function setDayVisibility(focusDay){
  // 段与标签
  segments.forEach((seg,idx)=>{
    const isFocus = !focusDay || seg.day===focusDay;
    const poly=polyRefs[idx], lab=labelRefs[idx];
    if(poly && poly._path){ poly._path.classList.toggle('muted', !isFocus); }
    if(lab){ const nd=lab.getElement(); if(nd) nd.classList.toggle('muted', !isFocus); }
  });
  // 地点标签（满足 #3）
  daysOrder.forEach(d=>{
    const list=pointMarkersByDay[d]||[];
    list.forEach(m=>{ const nd=m.getElement(); if(nd) nd.classList.toggle('muted', !!focusDay && d!==focusDay); });
  });
}

function toggleFocus(day, btnEl){
  if(dayFocus.current === day){
    dayFocus.current = null;
    document.querySelectorAll('.btn-day').forEach(b=> b.classList.remove('active'));
    setDayVisibility(null);
  }else{
    dayFocus.current = day;
    document.querySelectorAll('.btn-day').forEach(b=> b.classList.remove('active'));
    if(btnEl) btnEl.classList.add('active');
    setDayVisibility(day);
  }
}

// —— 编辑当日序列 ——
function editDay(day){
  const cur = (daySeqs[day]||[]).join('→');
  const tip = `请输入 ${day} 的路线（使用下方“可用地名”，用→分隔）。\n当前：${cur}\n示例：九寨沟→神仙池→迭部`;
  const val = prompt(tip, cur);
  if(val==null) return;
  const names = val.split('→').map(s=>s.trim()).filter(Boolean);
  if(names.length<2){ alert('至少需要起点和终点'); return; }
  for(const n of names){ if(!pointLookup[n]){ alert('不存在的地名：'+n); return; } }
  daySeqs[day]=names;
  // 保存编辑标记
  const obj=JSON.parse(localStorage.getItem(STORAGE_KEY)||'{}');
  obj.edits = obj.edits || {}; obj.edits[day]=names; localStorage.setItem(STORAGE_KEY, JSON.stringify(obj));
  // 重建
  const prevChecks = checkRefs.map(el=> el && el.checked ? 1:0);
  buildAll();
  // 恢复尽可能多的前缀勾选
  const m = Math.min(prevChecks.length, checkRefs.length);
  for(let i=0;i<m;i++){
    if(prevChecks[i]===1){
      if(i===0 || (checkRefs[i-1] && checkRefs[i-1].checked)){ checkRefs[i].checked=true; } else { break; }
    } else { break; }
  }
  applySeqRules(); refreshVisuals(); saveChecks(); buildLegend();
}

function restoredEdits(){
  const obj=JSON.parse(localStorage.getItem(STORAGE_KEY)||'{}'); const edits=obj.edits||{};
  Object.keys(edits).forEach(d=>{ if(Array.isArray(edits[d]) && edits[d].length>=2) daySeqs[d]=edits[d]; });
  return Object.keys(edits);
}

// —— 启动 ——
initMap(); buildLookup(); restoredEdits(); buildAll(); buildLegend();
</script>
</body>
</html>
"""
path = "/mnt/data/川甘环线-交互图例可编辑-高德底图.html"
with open(path, "w", encoding="utf-8") as f:
    f.write(html)
path
