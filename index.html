<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>川甘环线地图</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    html, body, #map { height: 100%; margin: 0; }
    .label-bg {
      color: #fff !important;
      font-weight: bold;
      padding: 2px 5px;
      border-radius: 4px;
      font-family: Arial, sans-serif;
      font-size: 12px;
      white-space: nowrap;
    }
    .checkbox-panel {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 1000;
      background: rgba(255,255,255,0.9);
      padding: 10px;
      border-radius: 8px;
      font-family: Arial, sans-serif;
      font-size: 14px;
    }
    .checkbox-panel h4 {
      margin: 0 0 5px 0;
    }
    .segment-checkbox {
      display: flex;
      align-items: center;
      margin-bottom: 5px;
    }
    .segment-checkbox input {
      margin-right: 6px;
    }
    .dimmed {
      filter: saturate(30%) brightness(90%);
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="checkbox-panel" id="panel">
    <h4 id="kmInfo">总里程: 0 km ｜ 剩余: 0 km</h4>
    <div id="checkboxes"></div>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    const days = [
      { day: "D1", color: "#e41a1c" },
      { day: "D2", color: "#377eb8" },
      { day: "D3", color: "#4daf4a" },
      { day: "D4", color: "#984ea3" },
      { day: "D5", color: "#ff7f00" },
      { day: "D6", color: "#ffff33" },
      { day: "D7", color: "#a65628" },
      { day: "D8", color: "#f781bf" }
    ];

    const route = [
      { day: "D1", name: "成都", lat: 30.5728, lng: 104.0668, alt: 500 },
      { day: "D1", name: "松潘", lat: 32.6389, lng: 103.5994, alt: 2850 },
      { day: "D1", name: "川主寺", lat: 32.794, lng: 103.669, alt: 3000 },
      { day: "D1", name: "九寨沟", lat: 33.262, lng: 103.918, alt: 2000 },
      { day: "D2", name: "神仙池", lat: 33.3, lng: 103.9, alt: 2400 },
      { day: "D2", name: "迭部", lat: 34.05, lng: 103.22, alt: 3000 },
      { day: "D3", name: "扎尕那", lat: 34.13, lng: 103.37, alt: 3200 },
      { day: "D3", name: "洛克之路", lat: 34.15, lng: 103.39, alt: 3300 },
      { day: "D3", name: "米拉日巴佛阁", lat: 34.2, lng: 103.3, alt: 3100 },
      { day: "D3", name: "合作", lat: 35.0, lng: 102.9, alt: 2900 },
      { day: "D4", name: "夏河", lat: 35.2, lng: 102.5, alt: 2900 },
      { day: "D4", name: "拉卜楞寺", lat: 35.2, lng: 102.52, alt: 2950 },
      { day: "D4", name: "桑科草原", lat: 35.25, lng: 102.6, alt: 3000 },
      { day: "D4", name: "禄曲", lat: 34.6, lng: 102.48, alt: 3100 },
      { day: "D4", name: "郎木寺", lat: 34.3, lng: 102.62, alt: 3200 },
      { day: "D5", name: "唐克", lat: 34.25, lng: 102.63, alt: 3400 },
      { day: "D6", name: "阿坝", lat: 32.9, lng: 101.7, alt: 3200 },
      { day: "D6", name: "各莫寺", lat: 32.8, lng: 101.6, alt: 3300 },
      { day: "D6", name: "莲宝叶则", lat: 32.9, lng: 101.4, alt: 4000 },
      { day: "D7", name: "观音桥", lat: 31.6, lng: 102.3, alt: 2600 },
      { day: "D7", name: "玉科草原", lat: 31.6, lng: 101.9, alt: 3500 },
      { day: "D7", name: "党龄", lat: 31.3, lng: 101.9, alt: 3300 },
      { day: "D7", name: "丹巴", lat: 30.88, lng: 101.88, alt: 1900 },
      { day: "D8", name: "巴郎山", lat: 30.9, lng: 102.8, alt: 4520 },
      { day: "D8", name: "成都", lat: 30.5728, lng: 104.0668, alt: 500 }
    ];

    const map = L.map("map").setView([32.5, 103], 7);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: "&copy; OpenStreetMap"
    }).addTo(map);

    // 路径分段
    const segments = [];
    for (let i = 0; i < route.length - 1; i++) {
      const day = route[i].day;
      const color = days.find(d => d.day === day).color;
      const seg = L.polyline([
        [route[i].lat, route[i].lng],
        [route[i+1].lat, route[i+1].lng]
      ], { color, weight: 5 }).addTo(map);
      seg.bindTooltip("高德导航（点击打开）");
      seg.on("click", () => {
        window.open(`https://amap.com/direction?from=${route[i].lng},${route[i].lat}&to=${route[i+1].lng},${route[i+1].lat}&mode=car`);
      });
      segments.push({ poly: seg, dist: map.distance([route[i].lat, route[i].lng], [route[i+1].lat, route[i+1].lng]) / 1000, day });
    }

    // 标签
    const placed = [];
    route.forEach((pt, idx) => {
      const color = days.find(d => d.day === pt.day).color;
      let offset = 0, lat = pt.lat, lng = pt.lng;
      while (placed.some(p => Math.abs(p.lat - lat) < 0.05 && Math.abs(p.lng - lng) < 0.05)) {
        offset += 0.02;
        lat = pt.lat + offset;
        lng = pt.lng + offset;
      }
      placed.push({ lat, lng });
      L.marker([lat, lng], {
        icon: L.divIcon({
          className: "",
          html: `<div class="label-bg" style="background:${color}!important">${pt.day} ${pt.name}｜${pt.alt}m</div>`
        })
      }).addTo(map);
    });

    // 复选框逻辑
    const totalKm = segments.reduce((a,b)=>a+b.dist,0).toFixed(0);
    let remaining = totalKm;
    const panel = document.getElementById("checkboxes");
    const kmInfo = document.getElementById("kmInfo");

    function updateKm() {
      kmInfo.textContent = `总里程: ${totalKm} km ｜ 剩余: ${remaining} km`;
    }

    function saveState() {
      localStorage.setItem("tripState", JSON.stringify(segments.map(s => s.checked)));
    }

    function loadState() {
      const saved = JSON.parse(localStorage.getItem("tripState") || "[]");
      saved.forEach((val,i) => {
        if(val){
          segments[i].checked = true;
          segments[i].poly.getElement().classList.add("dimmed");
          remaining -= segments[i].dist.toFixed(0);
          checkboxes[i].checked = true;
        }
      });
      updateKm();
      enforceSequential();
    }

    function enforceSequential() {
      let block = false;
      checkboxes.forEach((cb,i) => {
        if(block) {
          cb.disabled = true;
        } else {
          cb.disabled = false;
          if(!cb.checked) block = true;
        }
      });
    }

    const checkboxes = [];
    segments.forEach((s,i) => {
      const div = document.createElement("div");
      div.className = "segment-checkbox";
      const cb = document.createElement("input");
      cb.type = "checkbox";
      const label = document.createElement("label");
      label.textContent = `${s.day} 段 ${s.dist.toFixed(0)} km`;
      label.style.background = s.poly.options.color;
      label.style.color = "#fff";
      label.style.padding = "2px 4px";
      label.style.borderRadius = "3px";
      div.appendChild(cb);
      div.appendChild(label);
      panel.appendChild(div);
      checkboxes.push(cb);

      cb.addEventListener("change", () => {
        if(cb.checked) {
          s.poly.getElement().classList.add("dimmed");
          remaining -= s.dist.toFixed(0);
          s.checked = true;
        } else {
          // 取消时清空后续
          for(let j=i;j<segments.length;j++){
            if(checkboxes[j].checked){
              checkboxes[j].checked=false;
              segments[j].poly.getElement().classList.remove("dimmed");
              remaining += segments[j].dist.toFixed(0);
              segments[j].checked=false;
            }
          }
        }
        updateKm();
        saveState();
        enforceSequential();
      });
    });

    updateKm();
    loadState();
  </script>
</body>
</html>
